<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>ç›´æ’­äº’å‹•è¸©åœ°é›· </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #1a1a1a;
            color: white;
            text-align: center;
        }

        .controls {
            margin: 15px;
            padding: 15px;
            background: #333;
            border-radius: 8px;
            display: inline-block;
        }

        input {
            width: 50px;
            padding: 5px;
            text-align: center;
        }

        button {
            padding: 5px 15px;
            background: #27ae60;
            color: white;
            border: none;
            cursor: pointer;
        }

        .game-wrapper {
            display: inline-block;
            background: #555;
            padding: 10px;
            border-radius: 4px;
        }

        .row {
            display: flex;
        }

        .cell {
            width: 30px;
            height: 30px;
            border: 1px solid #777;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #bbb;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            box-sizing: border-box;
        }

        .cell.revealed {
            background: #eee;
            border-color: #ccc;
        }

        .cell.mine {
            background: #e74c3c !important;
        }

        .cell.flagged {
            background: #f1c40f;
        }

        .cell.label {
            background: #333;
            color: #fff;
            border-color: #222;
            font-size: 12px;
        }

        /* ç´…ç·šèˆ‡è¼”åŠ©æ•¸å­— */
        .r-border {
            border-right: 2px solid rgba(255, 0, 0, 0.8) !important;
        }

        .b-border {
            border-bottom: 2px solid rgba(255, 0, 0, 0.8) !important;
        }

        .guide-num {
            position: absolute;
            bottom: 0px;
            right: 1px;
            font-size: 9px;
            color: red;
            background: rgba(255, 255, 255, 0.7);
            padding: 0 1px;
            pointer-events: none;
            line-height: 1;
        }

        .n1 {
            color: blue;
        }

        .n2 {
            color: green;
        }

        .n3 {
            color: red;
        }

        .n4 {
            color: darkblue;
        }

        #log {
            margin-top: 10px;
            color: #f1c40f;
            font-size: 1.1em;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h1>ğŸ’£ YouTube æŒ‡ä»¤è¸©åœ°é›· (åº§æ¨™å¾1é–‹å§‹)</h1>
    æŒ‡ä»¤ç¯„ä¾‹: !open A 1 æˆ– !flag B 5
    <div class="controls">
        å¯¬(X): <input type="number" id="w" value="15">
        é«˜(Y): <input type="number" id="h" value="10">
        é›·æ•¸: <input type="number" id="m" value="20">
        <button onclick="initGame()">ç”Ÿæˆæ–°åœ°åœ–</button>
    </div>
    <div id="log">æŒ‡ä»¤ç¯„ä¾‹: !open A 1 æˆ– !flag B 5</div>

    <div class="game-wrapper" id="board"></div>

    <script>
        const socket = io();
        let board = [], rows, cols, mines, gameActive = true;

        function indexToLetter(idx) {
            let label = "";
            while (idx >= 0) {
                label = String.fromCharCode((idx % 26) + 65) + label;
                idx = Math.floor(idx / 26) - 1;
            }
            return label;
        }

        function initGame() {
            cols = parseInt(document.getElementById('w').value);
            rows = parseInt(document.getElementById('h').value);
            mines = parseInt(document.getElementById('m').value);
            board = Array.from({ length: rows }, () => Array.from({ length: cols }, () => ({
                isMine: false, rev: false, count: 0, isFlagged: false
            })));
            gameActive = true;

            let p = 0;
            while (p < mines) {
                let r = Math.floor(Math.random() * rows), c = Math.floor(Math.random() * cols);
                if (!board[r][c].isMine) { board[r][c].isMine = true; p++; }
            }
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    if (board[r][c].isMine) continue;
                    let n = 0;
                    for (let i = -1; i <= 1; i++) for (let j = -1; j <= 1; j++) {
                        let nr = r + i, nc = c + j;
                        if (nr >= 0 && nr < rows && nc >= 0 && nc < cols && board[nr][nc].isMine) n++;
                    }
                    board[r][c].count = n;
                }
            }
            render();
        }

        function render() {
            const el = document.getElementById('board');
            el.innerHTML = '';

            // --- é ‚éƒ¨ X è»¸æ¨™ç±¤ ---
            let hr = document.createElement('div'); hr.className = 'row';
            hr.appendChild(createCell(' ', 'label'));
            for (let c = 0; c < cols; c++) {
                let cell = createCell(indexToLetter(c), 'label');
                if ((c + 1) % 5 === 0 && c !== cols - 1) cell.classList.add('r-border');
                hr.appendChild(cell);
            }
            el.appendChild(hr);

            // --- ç”ŸæˆéŠæˆ²å€ ---
            for (let r = 0; r < rows; r++) {
                let rowDiv = document.createElement('div'); rowDiv.className = 'row';

                // å·¦å´ Y è»¸æ¨™ç±¤ï¼šé¡¯ç¤º r + 1
                let labelCell = createCell(r + 1, 'label');
                if ((r + 1) % 5 === 0 && r !== rows - 1) labelCell.classList.add('b-border');
                rowDiv.appendChild(labelCell);

                for (let c = 0; c < cols; c++) {
                    let d = board[r][c];
                    let div = document.createElement('div');
                    div.className = 'cell';
                    if (d.rev) {
                        div.classList.add('revealed');
                        if (d.isMine) { div.innerText = 'ğŸ’£'; div.classList.add('mine'); }
                        else if (d.count > 0) { div.innerText = d.count; div.classList.add('n' + d.count); }
                    } else if (d.isFlagged) {
                        div.innerText = 'ğŸš©';
                        div.classList.add('flagged');
                    }

                    // ç´…ç·š
                    if ((c + 1) % 5 === 0 && c !== cols - 1) {
                        div.classList.add('r-border');
                        if (!div.querySelector('.guide-num')) {
                            let guide = document.createElement('span');
                            guide.className = 'guide-num';
                            guide.innerText = r + 1;
                            div.appendChild(guide);
                        }
                    }
                    if ((r + 1) % 5 === 0 && r !== rows - 1) {
                        div.classList.add('b-border');

                        let guide = document.createElement('span');
                        guide.className = 'guide-num';
                        guide.innerText = indexToLetter(c);
                        div.appendChild(guide);

                    }

                    // å‚³å…¥çš„ label ä¹Ÿè¦æ”¹æˆ 1-based æ–¹ä¾¿ Log é¡¯ç¤º
                    let coordLabel = indexToLetter(c) + (r + 1);
                    div.onclick = () => remoteOpen(r, c, "ä¸»æ’­", coordLabel);
                    div.oncontextmenu = (e) => { e.preventDefault(); remoteFlag(r, c, "ä¸»æ’­", coordLabel); };

                    rowDiv.appendChild(div);
                }
                el.appendChild(rowDiv);
            }
        }

        function createCell(text, cls) {
            let d = document.createElement('div');
            d.className = 'cell ' + (cls || '');
            d.innerText = text;
            return d;
        }

        function remoteOpen(r, c, user, label) {
            if (!gameActive || r < 0 || r >= rows || c < 0 || c >= cols) return;
            if (board[r][c].rev || board[r][c].isFlagged) return;

            board[r][c].rev = true;
            let res = "SAFE";

            if (board[r][c].isMine) {
                res = "BOOM"; gameActive = false;
                board.forEach(row => row.forEach(cc => { if (cc.isMine) cc.rev = true; }));
                document.getElementById('log').innerText = `ğŸ’¥ [${user}] ç‚¸äº†ï¼`;
            } else {
                if (board[r][c].count === 0) expand(r, c);
                if (board.every(row => row.every(cc => cc.isMine || cc.rev))) {
                    res = "WIN"; gameActive = false;
                    document.getElementById('log').innerText = `ğŸ‰ [${user}] ç²å‹ï¼`;
                } else {
                    document.getElementById('log').innerText = `[${user}] é–‹å•Ÿ ${label}`;
                }
            }
            render();
            socket.emit('report_result', { user, coord: label, result: res });
        }

        function remoteFlag(r, c, user, label) {
            if (!gameActive || r < 0 || r >= rows || c < 0 || c >= cols) return;
            if (board[r][c].rev) return;

            board[r][c].isFlagged = !board[r][c].isFlagged;
            document.getElementById('log').innerText = `[${user}] ${board[r][c].isFlagged ? 'æ¨™è¨˜' : 'å–æ¶ˆ'} ${label}`;
            render();
            socket.emit('report_result', { user, coord: label, result: "FLAG" });
        }

        function expand(r, c) {
            for (let i = -1; i <= 1; i++) for (let j = -1; j <= 1; j++) {
                let nr = r + i, nc = c + j;
                if (nr >= 0 && nr < rows && nc >= 0 && nc < cols && !board[nr][nc].rev && !board[nr][nc].isMine && !board[nr][nc].isFlagged) {
                    board[nr][nc].rev = true;
                    if (board[nr][nc].count === 0) expand(nr, nc);
                }
            }
        }

        socket.on('game_command', (data) => {
            if (data.action === 'open') remoteOpen(data.y, data.x, data.user, data.coord_label);
            if (data.action === 'flag') remoteFlag(data.y, data.x, data.user, data.coord_label);
        });

        initGame();
    </script>
</body>

</html>